name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  PROJECT_ID: adk-rag-ma
  REGION: us-west1
  BACKEND_IMAGE: us-west1-docker.pkg.dev/adk-rag-ma/cloud-run-repo1/backend
  FRONTEND_IMAGE: us-west1-docker.pkg.dev/adk-rag-ma/cloud-run-repo1/frontend

jobs:
  test-backend:
    runs-on: ubuntu-latest
    name: Backend Tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        cd backend
        pip install -r requirements.txt
        
    - name: Run security scan with bandit
      run: |
        pip install bandit[toml]
        bandit -r backend/src -f json -o bandit-report.json || true
        
    - name: Run tests with coverage
      run: |
        cd backend
        pytest tests/ -v --cov=src --cov-report=xml --cov-report=term-missing
        
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: backend/coverage.xml
        flags: backend
        
    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: backend-test-results
        path: |
          backend/coverage.xml
          bandit-report.json

  test-frontend:
    runs-on: ubuntu-latest
    name: Frontend Tests
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    - name: Install dependencies
      run: |
        cd frontend
        npm ci
        
    - name: Run ESLint
      run: |
        cd frontend
        npm run lint
        
    - name: Run type checking
      run: |
        cd frontend
        npm run type-check
        
    - name: Build frontend
      run: |
        cd frontend
        npm run build

  security-scan:
    runs-on: ubuntu-latest
    name: Security Scanning
    needs: [test-backend, test-frontend]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  build-and-deploy:
    runs-on: ubuntu-latest
    name: Build and Deploy
    needs: [test-backend, test-frontend, security-scan]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      
    - name: Configure Docker for Artifact Registry
      run: |
        gcloud auth configure-docker us-west1-docker.pkg.dev
        
    - name: Build backend image
      run: |
        cd backend
        gcloud builds submit . \
          --config=cloudbuild.yaml \
          --substitutions=_BACKEND_IMAGE="$BACKEND_IMAGE:$GITHUB_SHA" \
          --project=$PROJECT_ID
          
    - name: Build frontend image
      run: |
        cd frontend
        gcloud builds submit . \
          --config=cloudbuild.yaml \
          --substitutions=_IMAGE_NAME="$FRONTEND_IMAGE:$GITHUB_SHA",_BACKEND_URL="https://34.49.46.115.nip.io" \
          --project=$PROJECT_ID
          
    - name: Deploy to Cloud Run
      run: |
        # Deploy backend services
        for service in backend backend-agent1 backend-agent2 backend-agent3; do
          gcloud run services update $service \
            --image="$BACKEND_IMAGE:$GITHUB_SHA" \
            --region=$REGION \
            --project=$PROJECT_ID \
            --update-env-vars="GOOGLE_CLOUD_LOCATION=$REGION,VERTEXAI_LOCATION=$REGION" \
            --quiet
        done
        
        # Deploy frontend
        gcloud run services update frontend \
          --image="$FRONTEND_IMAGE:$GITHUB_SHA" \
          --region=$REGION \
          --project=$PROJECT_ID \
          --quiet
          
    - name: Run smoke tests
      run: |
        # Wait for deployment to be ready
        sleep 60
        
        # Test health endpoints
        curl -f https://34.49.46.115.nip.io/api/health || exit 1
        
        # Test each agent endpoint
        for agent in agent1 agent2 agent3; do
          curl -f https://34.49.46.115.nip.io/$agent/api/health || exit 1
        done
        
    - name: Notify deployment success
      if: success()
      run: |
        echo "✅ Deployment successful!"
        echo "Backend image: $BACKEND_IMAGE:$GITHUB_SHA"
        echo "Frontend image: $FRONTEND_IMAGE:$GITHUB_SHA"
        
    - name: Notify deployment failure
      if: failure()
      run: |
        echo "❌ Deployment failed!"
        exit 1

  rollback:
    runs-on: ubuntu-latest
    name: Rollback on Failure
    needs: [build-and-deploy]
    if: failure() && github.ref == 'refs/heads/main'
    
    steps:
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
        
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      
    - name: Rollback services
      run: |
        # Get previous revision for each service and rollback
        for service in backend backend-agent1 backend-agent2 backend-agent3 frontend; do
          echo "Rolling back $service..."
          
          # Get the previous revision
          PREVIOUS_REVISION=$(gcloud run revisions list \
            --service=$service \
            --region=$REGION \
            --project=$PROJECT_ID \
            --format="value(metadata.name)" \
            --limit=2 | tail -n 1)
            
          if [ ! -z "$PREVIOUS_REVISION" ]; then
            gcloud run services update-traffic $service \
              --to-revisions=$PREVIOUS_REVISION=100 \
              --region=$REGION \
              --project=$PROJECT_ID \
              --quiet
            echo "✅ Rolled back $service to $PREVIOUS_REVISION"
          else
            echo "⚠️ No previous revision found for $service"
          fi
        done
