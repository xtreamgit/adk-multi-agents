"""
User repository for database operations.
"""

import json
from typing import Optional, List, Dict
from datetime import datetime, timezone

from ..connection import get_db_connection


class UserRepository:
    """Repository for user-related database operations."""
    
    @staticmethod
    def get_by_id(user_id: int) -> Optional[Dict]:
        """Get user by ID."""
        with get_db_connection() as conn:
            cursor = conn.cursor()
            cursor.execute("SELECT * FROM users WHERE id = %s", (user_id,))
            row = cursor.fetchone()
            return dict(row) if row else None
    
    @staticmethod
    def get_by_username(username: str, active_only: bool = True) -> Optional[Dict]:
        """Get user by username. By default, only returns active users."""
        with get_db_connection() as conn:
            cursor = conn.cursor()
            if active_only:
                cursor.execute("SELECT * FROM users WHERE username = %s AND is_active = TRUE", (username,))
            else:
                cursor.execute("SELECT * FROM users WHERE username = %s", (username,))
            row = cursor.fetchone()
            return dict(row) if row else None
    
    @staticmethod
    def get_by_email(email: str, active_only: bool = True) -> Optional[Dict]:
        """Get user by email. By default, only returns active users."""
        with get_db_connection() as conn:
            cursor = conn.cursor()
            if active_only:
                cursor.execute("SELECT * FROM users WHERE email = %s AND is_active = TRUE", (email,))
            else:
                cursor.execute("SELECT * FROM users WHERE email = %s", (email,))
            row = cursor.fetchone()
            return dict(row) if row else None
    
    @staticmethod
    def get_by_google_id(google_id: str) -> Optional[Dict]:
        """Get user by Google ID (from IAP authentication)."""
        with get_db_connection() as conn:
            cursor = conn.cursor()
            cursor.execute("SELECT * FROM users WHERE google_id = %s", (google_id,))
            row = cursor.fetchone()
            return dict(row) if row else None
    
    @staticmethod
    def create(username: str, email: str, full_name: str, hashed_password: str) -> Dict:
        """Create a new user."""
        created_at = datetime.now(timezone.utc).isoformat()
        updated_at = created_at
        
        with get_db_connection() as conn:
            cursor = conn.cursor()
            cursor.execute("""
                INSERT INTO users (username, email, full_name, hashed_password, 
                                   is_active, created_at, updated_at)
                VALUES (%s, %s, %s, %s, %s, %s, %s)
                RETURNING id
            """, (username, email, full_name, hashed_password, True, created_at, updated_at))
            result = cursor.fetchone()
            user_id = result['id'] if isinstance(result, dict) else result[0]
            conn.commit()
        
        return UserRepository.get_by_id(user_id)
    
    @staticmethod
    def create_iap_user(username: str, email: str, full_name: str, google_id: str) -> Dict:
        """Create a new user from IAP authentication (no password required)."""
        created_at = datetime.now(timezone.utc).isoformat()
        updated_at = created_at
        
        with get_db_connection() as conn:
            cursor = conn.cursor()
            cursor.execute("""
                INSERT INTO users (username, email, full_name, google_id, auth_provider,
                                   is_active, created_at, updated_at)
                VALUES (%s, %s, %s, %s, %s, %s, %s, %s)
                RETURNING id
            """, (username, email, full_name, google_id, 'iap', True, created_at, updated_at))
            result = cursor.fetchone()
            user_id = result['id'] if isinstance(result, dict) else result[0]
            conn.commit()
        
        return UserRepository.get_by_id(user_id)
    
    @staticmethod
    def update(user_id: int, **kwargs) -> Optional[Dict]:
        """Update user fields."""
        if not kwargs:
            return UserRepository.get_by_id(user_id)
        
        # Add updated_at timestamp
        kwargs['updated_at'] = datetime.now(timezone.utc).isoformat()
        
        # Build UPDATE query
        set_clause = ", ".join([f"{key} = %s" for key in kwargs.keys()])
        values = list(kwargs.values()) + [user_id]
        
        with get_db_connection() as conn:
            cursor = conn.cursor()
            cursor.execute(f"UPDATE users SET {set_clause} WHERE id = %s", values)
            conn.commit()
        
        return UserRepository.get_by_id(user_id)
    
    @staticmethod
    def update_last_login(user_id: int) -> bool:
        """Update the last login timestamp."""
        last_login = datetime.now(timezone.utc).isoformat()
        with get_db_connection() as conn:
            cursor = conn.cursor()
            cursor.execute("UPDATE users SET last_login = %s WHERE id = %s", (last_login, user_id))
            conn.commit()
            return cursor.rowcount > 0
    
    @staticmethod
    def exists(username: str) -> bool:
        """Check if a user exists."""
        with get_db_connection() as conn:
            cursor = conn.cursor()
            cursor.execute("SELECT 1 FROM users WHERE username = %s LIMIT 1", (username,))
            return cursor.fetchone() is not None
    
    @staticmethod
    def get_profile(user_id: int) -> Optional[Dict]:
        """Get user profile."""
        with get_db_connection() as conn:
            cursor = conn.cursor()
            cursor.execute("SELECT * FROM user_profiles WHERE user_id = %s", (user_id,))
            row = cursor.fetchone()
            if row:
                profile = dict(row)
                # Parse JSON preferences
                if profile.get('preferences'):
                    try:
                        profile['preferences'] = json.loads(profile['preferences'])
                    except (json.JSONDecodeError, TypeError):
                        profile['preferences'] = {}
                return profile
            return None
    
    @staticmethod
    def create_profile(user_id: int, theme: str = 'light', language: str = 'en', 
                       timezone: str = 'UTC', preferences: Optional[Dict] = None) -> Dict:
        """Create user profile."""
        preferences_json = json.dumps(preferences) if preferences else None
        
        with get_db_connection() as conn:
            cursor = conn.cursor()
            cursor.execute("""
                INSERT INTO user_profiles (user_id, theme, language, timezone, preferences)
                VALUES (%s, %s, %s, %s, %s)
            """, (user_id, theme, language, timezone, preferences_json))
            conn.commit()
        
        return UserRepository.get_profile(user_id)
    
    @staticmethod
    def update_profile(user_id: int, **kwargs) -> Optional[Dict]:
        """Update user profile."""
        if not kwargs:
            return UserRepository.get_profile(user_id)
        
        # Convert preferences dict to JSON string
        if 'preferences' in kwargs and kwargs['preferences'] is not None:
            kwargs['preferences'] = json.dumps(kwargs['preferences'])
        
        # Build UPDATE query
        set_clause = ", ".join([f"{key} = %s" for key in kwargs.keys()])
        values = list(kwargs.values()) + [user_id]
        
        with get_db_connection() as conn:
            cursor = conn.cursor()
            cursor.execute(f"UPDATE user_profiles SET {set_clause} WHERE user_id = %s", values)
            conn.commit()
        
        return UserRepository.get_profile(user_id)
    
    @staticmethod
    def get_groups(user_id: int) -> List[int]:
        """Get group IDs for a user."""
        with get_db_connection() as conn:
            cursor = conn.cursor()
            cursor.execute("SELECT group_id FROM user_groups WHERE user_id = %s", (user_id,))
            return [row['group_id'] for row in cursor.fetchall()]
    
    @staticmethod
    def add_to_group(user_id: int, group_id: int) -> bool:
        """Add user to a group. Idempotent - safe to call multiple times."""
        try:
            with get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("""
                    INSERT INTO user_groups (user_id, group_id)
                    VALUES (%s, %s)
                    ON CONFLICT (user_id, group_id) DO NOTHING
                """, (user_id, group_id))
                conn.commit()
            return True
        except Exception:
            return False
    
    @staticmethod
    def remove_from_group(user_id: int, group_id: int) -> bool:
        """Remove user from a group."""
        with get_db_connection() as conn:
            cursor = conn.cursor()
            cursor.execute("""
                DELETE FROM user_groups WHERE user_id = %s AND group_id = %s
            """, (user_id, group_id))
            conn.commit()
            return cursor.rowcount > 0
    
    @staticmethod
    def get_all(active_only: bool = True) -> List[Dict]:
        """Get all users, optionally filtering by active status."""
        with get_db_connection() as conn:
            cursor = conn.cursor()
            if active_only:
                cursor.execute("SELECT * FROM users WHERE is_active = TRUE ORDER BY created_at DESC")
            else:
                cursor.execute("SELECT * FROM users ORDER BY created_at DESC")
            return [dict(row) for row in cursor.fetchall()]
    
    @staticmethod
    def update_password(user_id: int, hashed_password: str) -> bool:
        """Update user password."""
        try:
            with get_db_connection() as conn:
                cursor = conn.cursor()
                cursor.execute("""
                    UPDATE users SET hashed_password = %s, updated_at = %s WHERE id = %s
                """, (hashed_password, datetime.now(timezone.utc).isoformat(), user_id))
                conn.commit()
            return True
        except Exception:
            return False
